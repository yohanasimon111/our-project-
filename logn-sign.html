<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authentication - HopeLink Mahama</title>
   
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
   
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
   
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
   
    <style>
        .auth-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .auth-card {
            background: white;
            border-radius: 1.5rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        .form-input {
            transition: all 0.3s ease;
            border: 2px solid #e5e7eb;
        }
        .form-input:focus {
            transform: translateY(-2px);
            box-shadow: 0 20px 25px -5px rgba(59, 130, 246, 0.3);
            border-color: #3b82f6;
        }
        .tab-active {
            background: linear-gradient(135deg, #3B82F6, #10B981);
            color: white;
        }
        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .notification {
            position: fixed;
            top: 100px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            color: white;
            z-index: 1001;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        .notification.show {
            transform: translateX(0);
        }
        .notification.success {
            background: linear-gradient(135deg, #10B981, #059669);
        }
        .notification.error {
            background: linear-gradient(135deg, #EF4444, #DC2626);
        }
        .notification.info {
            background: linear-gradient(135deg, #3B82F6, #2563EB);
        }
        .otp-input {
            width: 3rem;
            height: 3rem;
            text-align: center;
            font-size: 1.25rem;
            font-weight: bold;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            transition: all 0.3s ease;
        }
        .otp-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .resend-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-primary {
            background: linear-gradient(135deg, #3B82F6, #2563EB);
            color: white;
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #2563EB, #1D4ED8);
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(37, 99, 235, 0.4);
        }
        .btn-success {
            background: linear-gradient(135deg, #10B981, #059669);
            color: white;
            transition: all 0.3s ease;
        }
        .btn-success:hover {
            background: linear-gradient(135deg, #059669, #047857);
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(5, 150, 105, 0.4);
        }
        .btn-purple {
            background: linear-gradient(135deg, #8B5CF6, #7C3AED);
            color: white;
            transition: all 0.3s ease;
        }
        .btn-purple:hover {
            background: linear-gradient(135deg, #7C3AED, #6D28D9);
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(124, 58, 237, 0.4);
        }
        .firebase-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            z-index: 1000;
        }
        .firebase-status.connected {
            background: rgba(16, 185, 129, 0.9);
            color: white;
        }
        .firebase-status.disconnected {
            background: rgba(239, 68, 68, 0.9);
            color: white;
        }
        .social-login-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 500;
            transition: all 0.3s ease;
            width: 100%;
        }
        .social-login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }
        .btn-google {
            background: white;
            color: #333;
            border: 2px solid #e5e7eb;
        }
        .btn-google:hover {
            background: #f8fafc;
            border-color: #d1d5db;
        }
        .divider {
            display: flex;
            align-items: center;
            text-align: center;
            margin: 1.5rem 0;
        }
        .divider::before,
        .divider::after {
            content: '';
            flex: 1;
            border-bottom: 1px solid #e5e7eb;
        }
        .divider span {
            padding: 0 1rem;
            color: #6b7280;
            font-size: 0.875rem;
        }
    </style>
</head>
<body class="font-sans">
    <!-- Firebase Configuration Script -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-analytics.js";
        import {
            getAuth,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            sendPasswordResetEmail,
            onAuthStateChanged,
            signOut,
            fetchSignInMethodsForEmail,
            updateProfile,
            GoogleAuthProvider,
            signInWithPopup
        } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
       
        // Add Firestore import here
        import {
            getFirestore,
            doc,
            setDoc,
            getDoc
        } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA6srTpyl7YXpr4t3Xij0Lx7DqmHsbaCPs",
            authDomain: "hopelink-mahama-d9cd4.firebaseapp.com",
            projectId: "hopelink-mahama-d9cd4",
            storageBucket: "hopelink-mahama-d9cd4.firebasestorage.app",
            messagingSenderId: "769873156422",
            appId: "1:769873156422:web:5d89b8c5695ce95bb6ad47",
            measurementId: "G-8TQ2LYP809"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
       
        // Initialize Firestore Database
        const db = getFirestore(app);
       
        // Initialize Google OAuth Provider
        const googleProvider = new GoogleAuthProvider();
       
        // Make auth and db available globally with error handling
        window.firebaseAuth = auth;
        window.firebaseApp = app;
        window.firebaseDb = db;
       
        // Create wrapper functions that are accessible globally
        window.firebaseSignIn = async (email, password) => {
            return await signInWithEmailAndPassword(auth, email, password);
        };
       
        window.firebaseSignUp = async (email, password) => {
            return await createUserWithEmailAndPassword(auth, email, password);
        };
       
        window.firebaseUpdateUserProfile = async (user, profileData) => {
            return await updateProfile(user, profileData);
        };
       
        window.firebaseSendPasswordReset = async (email) => {
            return await sendPasswordResetEmail(auth, email);
        };
       
        // Google Sign In function
        window.signInWithGoogle = async () => {
            try {
                const result = await signInWithPopup(auth, googleProvider);
                const user = result.user;
               
                // Save user data to Firestore
                await saveUserToFirestoreIfNew(user);
               
                return { success: true, user: user };
            } catch (error) {
                console.error("Google Sign In Error:", error);
                return { success: false, error: error };
            }
        };
       
        // Function to save user data to Firestore if new user
        async function saveUserToFirestoreIfNew(user) {
            try {
                // Check if user already exists in Firestore
                const userRef = doc(db, "users", user.uid);
                const userDoc = await getDoc(userRef);
               
                if (!userDoc.exists()) {
                    // User is new, save their data
                    const userData = {
                        email: user.email,
                        displayName: user.displayName || "",
                        photoURL: user.photoURL || "",
                        provider: user.providerData[0]?.providerId || "google",
                        role: "user",
                        accountStatus: "active",
                        profileComplete: false,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };
                   
                    await setDoc(userRef, userData, { merge: true });
                    console.log("✅ New Google user saved to Firestore:", user.email);
                } else {
                    console.log("✅ Existing Google user:", user.email);
                }
                return true;
            } catch (error) {
                console.error("❌ Error checking/saving Google user:", error);
                return false;
            }
        }
       
        // Function to save user data to Firestore - MODIFIED TO WORK PROPERLY
        window.saveUserDataToFirestore = async function(userId, userData) {
            try {
                console.log("Attempting to save to Firestore for user:", userId);
                const userRef = doc(db, "users", userId);
                await setDoc(userRef, {
                    ...userData,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                }, { merge: true });
                console.log("Firebase: User data saved to Firestore:", userId);
                return true;
            } catch (error) {
                console.error("Firebase: Error saving user data to Firestore:", error);
                return false;
            }
        };
       
        // Enhanced connection test with more details
        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log("Firebase: User detected", user.email);
                console.log("Firebase: User UID", user.uid);
                console.log("Firebase: User metadata", user.metadata);
                console.log("Firebase: User provider data", user.providerData);
               
                // Update global user info
                window.currentUser = {
                    uid: user.uid,
                    email: user.email,
                    displayName: user.displayName,
                    emailVerified: user.emailVerified,
                    isAnonymous: user.isAnonymous,
                    metadata: user.metadata,
                    providerData: user.providerData
                };
            } else {
                console.log("Firebase: No user detected");
                window.currentUser = null;
            }
        });
       
        console.log("Firebase initialized: Project ID =", firebaseConfig.projectId);
        console.log("Firebase Auth instance created:", auth);
        console.log("Firestore Database instance created:", db);
        console.log("Google Auth Provider initialized");
        console.log("Firebase functions available: signIn, signUp, updateProfile, saveUserDataToFirestore, signInWithGoogle");
    </script>

    <!-- Navigation -->
    <nav class="bg-white shadow-lg fixed w-full z-50">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-3">
                    <div class="bg-gradient-to-r from-blue-500 to-green-500 p-3 rounded-xl">
                        <i class="fas fa-hands-helping text-white text-xl"></i>
                    </div>
                    <div>
                        <div class="font-bold text-xl text-gray-800">HopeLink</div>
                        <div class="text-xs text-green-500 font-semibold">Mahama Refugee Camp</div>
                    </div>
                </div>
                <a href="index.html" class="btn-primary px-6 py-2.5 rounded-lg font-semibold shadow-lg hover:shadow-xl transition-all duration-300 flex items-center space-x-2">
                    <i class="fas fa-home"></i>
                    <span>Back to Home</span>
                </a>
            </div>
        </div>
    </nav>

    <!-- Firebase Status Indicator -->
    <div id="firebase-status" class="firebase-status disconnected">
        <i class="fas fa-circle"></i>
        <span id="firebase-status-text">Firebase: Connecting...</span>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification">
        <div class="flex items-center space-x-3">
            <i id="notificationIcon" class="fas fa-check-circle"></i>
            <span id="notificationMessage">Action completed successfully!</span>
            <button onclick="hideNotification()" class="ml-4 opacity-70 hover:opacity-100">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <!-- Authentication Section -->
    <div class="auth-container pt-20">
        <div class="min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
            <div class="auth-card w-full max-w-md">
                <div class="p-8">
                    <!-- Tab Navigation -->
                    <div class="flex border-b border-gray-200 mb-8">
                        <button id="login-tab" class="flex-1 py-4 px-6 text-center font-semibold text-gray-500 hover:text-blue-500 transition tab-active">
                            Sign In
                        </button>
                        <button id="signup-tab" class="flex-1 py-4 px-6 text-center font-semibold text-gray-500 hover:text-blue-500 transition">
                            Sign Up
                        </button>
                    </div>

                    <!-- Login Form -->
                    <div id="login-form-container">
                        <h2 class="text-3xl font-bold text-gray-800 mb-2 text-center">Welcome Back</h2>
                        <p class="text-gray-600 text-center mb-8">Sign in to your HopeLink account</p>

                        <!-- Google Login Button -->
                        <div class="mb-6">
                            <button type="button" onclick="handleGoogleLogin()" class="social-login-btn btn-google">
                                <i class="fab fa-google text-red-500"></i>
                                <span>Continue with Google</span>
                            </button>
                        </div>

                        <div class="divider">
                            <span>Or continue with email</span>
                        </div>

                        <form id="loginForm" class="space-y-6">
                            <div>
                                <label class="block text-gray-700 font-medium mb-2">Email Address</label>
                                <input type="email" id="login-email" required
                                       class="form-input w-full p-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                       placeholder="Enter your email">
                            </div>

                            <div>
                                <label class="block text-gray-700 font-medium mb-2">Password</label>
                                <input type="password" id="login-password" required
                                       class="form-input w-full p-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                       placeholder="Enter your password">
                            </div>

                            <div class="flex items-center justify-between">
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" id="remember-me" class="rounded border-gray-300 text-blue-500 focus:ring-blue-500">
                                    <span class="text-gray-600">Remember me</span>
                                </label>
                                <button type="button" id="forgot-password-btn" class="text-blue-500 hover:text-blue-600 text-sm font-medium">
                                    Forgot password?
                                </button>
                            </div>

                            <div id="login-error" class="hidden bg-red-50 border border-red-200 text-red-700 p-3 rounded-lg text-sm"></div>
                            <div id="login-success" class="hidden bg-green-50 border border-green-200 text-green-700 p-3 rounded-lg text-sm"></div>

                            <button type="submit" class="w-full btn-primary py-4 rounded-lg font-semibold flex items-center justify-center space-x-2">
                                <span id="login-button-text">Sign In</span>
                                <div id="login-spinner" class="loading-spinner hidden"></div>
                            </button>
                        </form>
                    </div>

                    <!-- Signup Form -->
                    <div id="signup-form-container" class="hidden">
                        <h2 class="text-3xl font-bold text-gray-800 mb-2 text-center">Create Account</h2>
                        <p class="text-gray-600 text-center mb-8">Join HopeLink community today</p>

                        <!-- Google Signup Button -->
                        <div class="mb-6">
                            <button type="button" onclick="handleGoogleLogin()" class="social-login-btn btn-google">
                                <i class="fab fa-google text-red-500"></i>
                                <span>Sign up with Google</span>
                            </button>
                        </div>

                        <div class="divider">
                            <span>Or sign up with email</span>
                        </div>

                        <form id="signupForm" class="space-y-6">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">First Name</label>
                                    <input type="text" id="signup-firstname" required
                                           class="form-input w-full p-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                           placeholder="John">
                                </div>
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">Last Name</label>
                                    <input type="text" id="signup-lastname" required
                                           class="form-input w-full p-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                           placeholder="Doe">
                                </div>
                            </div>

                            <div>
                                <label class="block text-gray-700 font-medium mb-2">Email Address</label>
                                <input type="email" id="signup-email" required
                                       class="form-input w-full p-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                       placeholder="john.doe@example.com">
                            </div>

                            <div>
                                <label class="block text-gray-700 font-medium mb-2">Password</label>
                                <input type="password" id="signup-password" required
                                       class="form-input w-full p-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                       placeholder="Create a strong password">
                            </div>

                            <div>
                                <label class="block text-gray-700 font-medium mb-2">Confirm Password</label>
                                <input type="password" id="signup-confirm-password" required
                                       class="form-input w-full p-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                       placeholder="Confirm your password">
                            </div>

                            <div class="flex items-start space-x-3">
                                <input type="checkbox" id="terms-agreement" required
                                       class="rounded border-gray-300 text-blue-500 focus:ring-blue-500 w-5 h-5 mt-1">
                                <label for="terms-agreement" class="text-gray-600 text-sm">
                                    I agree to the <a href="#" class="text-blue-500 hover:text-blue-600 font-medium">Terms of Service</a> and <a href="#" class="text-blue-500 hover:text-blue-600 font-medium">Privacy Policy</a>
                                </label>
                            </div>

                            <div id="signup-error" class="hidden bg-red-50 border border-red-200 text-red-700 p-3 rounded-lg text-sm"></div>
                            <div id="signup-success" class="hidden bg-green-50 border border-green-200 text-green-700 p-3 rounded-lg text-sm"></div>

                            <button type="submit" class="w-full btn-success py-4 rounded-lg font-semibold flex items-center justify-center space-x-2">
                                <span id="signup-button-text">Create Account</span>
                                <div id="signup-spinner" class="loading-spinner hidden"></div>
                            </button>
                        </form>
                    </div>

                    <!-- Forgot Password - Email Input -->
                    <div id="forgot-password-container" class="hidden">
                        <h2 class="text-3xl font-bold text-gray-800 mb-2 text-center">Reset Password</h2>
                        <p class="text-gray-600 text-center mb-8">Enter your email to receive a verification code</p>

                        <form id="forgotPasswordForm" class="space-y-6">
                            <div>
                                <label class="block text-gray-700 font-medium mb-2">Email Address</label>
                                <input type="email" id="forgot-password-email" required
                                       class="form-input w-full p-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                       placeholder="Enter your email">
                            </div>

                            <div id="forgot-password-error" class="hidden bg-red-50 border border-red-200 text-red-700 p-3 rounded-lg text-sm"></div>
                            <div id="forgot-password-success" class="hidden bg-green-50 border border-green-200 text-green-700 p-3 rounded-lg text-sm"></div>

                            <button type="submit" class="w-full btn-purple py-4 rounded-lg font-semibold flex items-center justify-center space-x-2">
                                <span id="forgot-password-button-text">Send Verification Code</span>
                                <div id="forgot-password-spinner" class="loading-spinner hidden"></div>
                            </button>

                            <button type="button" id="back-to-login" class="w-full text-blue-500 hover:text-blue-600 font-semibold py-2 transition flex items-center justify-center space-x-2">
                                <i class="fas fa-arrow-left"></i>
                                <span>Back to Login</span>
                            </button>
                        </form>
                    </div>

                    <!-- OTP Verification -->
                    <div id="otp-verification-container" class="hidden">
                        <h2 class="text-3xl font-bold text-gray-800 mb-2 text-center">Verify Code</h2>
                        <p class="text-gray-600 text-center mb-2">Enter the 6-digit code sent to your email</p>
                        <p id="otp-email" class="text-blue-600 text-center mb-8 font-medium"></p>

                        <form id="otpVerificationForm" class="space-y-6">
                            <div class="flex justify-center space-x-3 mb-6">
                                <input type="text" maxlength="1" class="otp-input" data-index="0" oninput="handleOtpInput(0)" onkeydown="handleOtpKeyDown(0, event)">
                                <input type="text" maxlength="1" class="otp-input" data-index="1" oninput="handleOtpInput(1)" onkeydown="handleOtpKeyDown(1, event)">
                                <input type="text" maxlength="1" class="otp-input" data-index="2" oninput="handleOtpInput(2)" onkeydown="handleOtpKeyDown(2, event)">
                                <input type="text" maxlength="1" class="otp-input" data-index="3" oninput="handleOtpInput(3)" onkeydown="handleOtpKeyDown(3, event)">
                                <input type="text" maxlength="1" class="otp-input" data-index="4" oninput="handleOtpInput(4)" onkeydown="handleOtpKeyDown(4, event)">
                                <input type="text" maxlength="1" class="otp-input" data-index="5" oninput="handleOtpInput(5)" onkeydown="handleOtpKeyDown(5, event)">
                            </div>

                            <!-- Timer and Resend -->
                            <div class="text-center space-y-3">
                                <div id="otp-timer" class="text-sm text-gray-600 font-medium">
                                    Code expires in: <span id="timer">10:00</span>
                                </div>
                                <button type="button" id="resend-otp-btn" class="text-blue-500 hover:text-blue-600 font-medium transition-colors resend-btn" disabled>
                                    Resend Code (<span id="resend-timer">60</span>s)
                                </button>
                            </div>

                            <div id="otp-error" class="hidden bg-red-50 border border-red-200 text-red-700 p-3 rounded-lg text-sm"></div>

                            <button type="submit" class="w-full btn-primary py-4 rounded-lg font-semibold flex items-center justify-center space-x-2">
                                <span id="otp-button-text">Verify Code</span>
                                <div id="otp-spinner" class="loading-spinner hidden"></div>
                            </button>

                            <button type="button" id="back-to-email" class="w-full text-blue-500 hover:text-blue-600 font-semibold py-3 transition-colors flex items-center justify-center space-x-2">
                                <i class="fas fa-arrow-left"></i>
                                <span>Back to Email</span>
                            </button>
                        </form>
                    </div>

                    <!-- New Password -->
                    <div id="new-password-container" class="hidden">
                        <h2 class="text-3xl font-bold text-gray-800 mb-2 text-center">New Password</h2>
                        <p class="text-gray-600 text-center mb-8">Create your new password</p>

                        <form id="newPasswordForm" class="space-y-6">
                            <div>
                                <label class="block text-gray-700 font-medium mb-2">New Password</label>
                                <input type="password" id="new-password" required
                                       class="form-input w-full p-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                       placeholder="Enter new password">
                            </div>

                            <div>
                                <label class="block text-gray-700 font-medium mb-2">Confirm New Password</label>
                                <input type="password" id="confirm-new-password" required
                                       class="form-input w-full p-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                       placeholder="Confirm new password">
                            </div>

                            <div id="new-password-error" class="hidden bg-red-50 border border-red-200 text-red-700 p-3 rounded-lg text-sm"></div>

                            <button type="submit" class="w-full btn-success py-4 rounded-lg font-semibold flex items-center justify-center space-x-2">
                                <span id="new-password-button-text">Reset Password</span>
                                <div id="new-password-spinner" class="loading-spinner hidden"></div>
                            </button>

                            <button type="button" id="back-to-otp" class="w-full text-blue-500 hover:text-blue-600 font-semibold py-3 transition-colors flex items-center justify-center space-x-2">
                                <i class="fas fa-arrow-left"></i>
                                <span>Back to Verification</span>
                            </button>
                        </form>
                    </div>

                    <!-- Reset Success -->
                    <div id="reset-success-container" class="hidden">
                        <div class="text-center space-y-6">
                            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto">
                                <i class="fas fa-check text-green-500 text-2xl"></i>
                            </div>
                            <h2 class="text-3xl font-bold text-gray-800">Password Reset!</h2>
                            <p class="text-gray-600">Your password has been successfully reset.</p>
                            <div class="bg-green-50 border border-green-200 text-green-700 p-4 rounded-xl text-sm">
                                You can now sign in with your new password.
                            </div>
                            <button type="button" id="go-to-login" class="w-full btn-primary py-4 rounded-lg font-semibold transition-all duration-300">
                                Sign In Now
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================================================
        // WORKING PASSWORD RESET SYSTEM WITH PROFESSIONAL COLORS
        // ============================================================================

        // Global state
        let currentView = 'login';
        let currentResetEmail = '';
        let otpCode = '';
        let otpTimer;
        let resendTimer;

        // Demo users for login functionality
        const demoUsers = [
            {
                email: "admin@hopelink.org",
                password: "admin123",
                name: "Administrator",
                role: "admin"
            },
            {
                email: "user@example.com",
                password: "user123",
                name: "Demo User",
                role: "user"
            }
        ];

        // Notification functions
        function showNotification(message, type = 'success', detail = '') {
            const notification = document.getElementById('notification');
            const icon = document.getElementById('notificationIcon');
            const messageEl = document.getElementById('notificationMessage');
           
            notification.className = `notification ${type}`;
            icon.className = type === 'success' ? 'fas fa-check-circle' :
                           type === 'error' ? 'fas fa-exclamation-circle' :
                           'fas fa-info-circle';
           
            if (detail) {
                messageEl.innerHTML = `${message}<br><small>${detail}</small>`;
            } else {
                messageEl.textContent = message;
            }
           
            notification.classList.add('show');
           
            setTimeout(() => {
                hideNotification();
            }, 5000);
        }

        function hideNotification() {
            const notification = document.getElementById('notification');
            notification.classList.remove('show');
        }

        // Utility functions
        function showLoading(buttonId, spinnerId, buttonTextId, loadingText) {
            const button = document.querySelector(buttonId);
            const spinner = document.getElementById(spinnerId);
            const buttonText = document.getElementById(buttonTextId);
           
            button.disabled = true;
            buttonText.textContent = loadingText;
            spinner.classList.remove('hidden');
        }

        function hideLoading(buttonId, spinnerId, buttonTextId, originalText) {
            const button = document.querySelector(buttonId);
            const spinner = document.getElementById(spinnerId);
            const buttonText = document.getElementById(buttonTextId);
           
            button.disabled = false;
            buttonText.textContent = originalText;
            spinner.classList.add('hidden');
        }

        function showError(elementId, message) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.classList.remove('hidden');
        }

        function hideError(elementId) {
            const element = document.getElementById(elementId);
            element.classList.add('hidden');
        }

        function showSuccess(elementId, message) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.classList.remove('hidden');
        }

        // Generate secure OTP
        function generateOTP() {
            return Math.floor(100000 + Math.random() * 900000).toString();
        }

        // Firebase status update
        function updateFirebaseStatus(connected) {
            const statusEl = document.getElementById('firebase-status');
            const statusTextEl = document.getElementById('firebase-status-text');
           
            if (connected) {
                statusEl.className = 'firebase-status connected';
                statusTextEl.textContent = 'Firebase: Connected';
            } else {
                statusEl.className = 'firebase-status disconnected';
                statusTextEl.textContent = 'Firebase: Disconnected (Demo Mode)';
            }
        }

        // ============================================================================
        // GOOGLE LOGIN FUNCTION
        // ============================================================================

        async function handleGoogleLogin() {
            try {
                if (!window.signInWithGoogle) {
                    showNotification('Google login not available', 'error', 'Please try email login or check console.');
                    return;
                }

                showNotification('Connecting to Google...', 'info', 'Please wait');

                const result = await window.signInWithGoogle();
               
                if (result.success && result.user) {
                    const user = result.user;
                   
                    // Store user session
                    sessionStorage.setItem('currentUser', JSON.stringify({
                        email: user.email,
                        uid: user.uid,
                        displayName: user.displayName,
                        emailVerified: user.emailVerified,
                        photoURL: user.photoURL,
                        loginTime: new Date().toISOString(),
                        isFirebaseUser: true,
                        provider: 'google'
                    }));

                    showNotification('Google login successful!', 'success', `Welcome ${user.displayName || user.email}!`);
                   
                    // Redirect to dashboard
                    setTimeout(() => {
                        window.location.href = 'dashboard.html';
                    }, 1500);
                } else {
                    throw new Error(result.error?.message || 'Google login failed');
                }
            } catch (error) {
                console.error('Google login error:', error);
               
                let errorMessage = 'Google login failed';
                if (error.code === 'auth/popup-closed-by-user') {
                    errorMessage = 'Login popup was closed. Please try again.';
                } else if (error.code === 'auth/account-exists-with-different-credential') {
                    errorMessage = 'An account already exists with this email. Please sign in with email/password.';
                } else if (error.code === 'auth/popup-blocked') {
                    errorMessage = 'Popup was blocked by browser. Please allow popups for this site.';
                } else {
                    errorMessage = error.message;
                }
               
                showNotification('Google login failed', 'error', errorMessage);
            }
        }

        // ============================================================================
        // LOGIN FUNCTIONALITY - PROFESSIONAL IMPLEMENTATION
        // ============================================================================

        async function handleLogin(e) {
            e.preventDefault();
           
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const rememberMe = document.getElementById('remember-me').checked;
           
            showLoading('#loginForm button[type="submit"]', 'login-spinner', 'login-button-text', 'Signing In...');
            hideError('login-error');
            hideError('login-success');

            try {
                // Validate inputs
                if (!email || !password) {
                    throw new Error('Please fill in all fields');
                }

                // Try Firebase login first if available
                if (window.firebaseAuth && window.firebaseSignIn) {
                    try {
                        console.log("Firebase: Attempting sign in with email:", email);
                        const userCredential = await window.firebaseSignIn(email, password);
                        const user = userCredential.user;
                       
                        console.log("Firebase: Sign in successful for user:", user.email);
                        console.log("Firebase: User UID:", user.uid);
                        console.log("Firebase: User metadata:", user.metadata);

                        // Save remembered email
                        if (rememberMe) {
                            localStorage.setItem('rememberedEmail', email);
                        } else {
                            localStorage.removeItem('rememberedEmail');
                        }

                        // Store user session with enhanced Firebase data
                        sessionStorage.setItem('currentUser', JSON.stringify({
                            email: user.email,
                            uid: user.uid,
                            displayName: user.displayName,
                            emailVerified: user.emailVerified,
                            isAnonymous: user.isAnonymous,
                            metadata: user.metadata,
                            providerData: user.providerData,
                            loginTime: new Date().toISOString(),
                            isFirebaseUser: true
                        }));

                        showSuccess('login-success', `Welcome back, ${user.email}! Redirecting...`);
                        showNotification(`Firebase authentication successful!`, 'success', `Welcome back, ${user.email}!`);

                        // Redirect to dashboard
                        setTimeout(() => {
                            window.location.href = 'dashboard.html';
                        }, 2000);
                        return;
                    } catch (firebaseError) {
                        console.log('Firebase login error:', firebaseError.code, firebaseError.message);
                       
                        // Provide more specific error messages based on Firebase error codes
                        let errorMessage = 'Login failed';
                        if (firebaseError.code === 'auth/user-not-found') {
                            errorMessage = 'No account found with this email address';
                        } else if (firebaseError.code === 'auth/wrong-password') {
                            errorMessage = 'Incorrect password';
                        } else if (firebaseError.code === 'auth/invalid-email') {
                            errorMessage = 'Invalid email address';
                        } else if (firebaseError.code === 'auth/user-disabled') {
                            errorMessage = 'This account has been disabled';
                        } else if (firebaseError.code === 'auth/too-many-requests') {
                            errorMessage = 'Too many failed login attempts. Please try again later';
                        } else {
                            errorMessage = firebaseError.message;
                        }
                       
                        // Show Firebase error and continue to demo users
                        showNotification('Firebase authentication failed', 'error', errorMessage);
                        console.log('Trying demo users as fallback');
                    }
                }

                // Simulate API call delay for demo users
                await new Promise(resolve => setTimeout(resolve, 1500));

                // Check credentials against demo users
                const user = demoUsers.find(u => u.email === email && u.password === password);
               
                if (!user) {
                    throw new Error('Invalid email or password');
                }

                // Save remembered email
                if (rememberMe) {
                    localStorage.setItem('rememberedEmail', email);
                } else {
                    localStorage.removeItem('rememberedEmail');
                }

                // Store user session
                sessionStorage.setItem('currentUser', JSON.stringify({
                    email: user.email,
                    name: user.name,
                    role: user.role,
                    loginTime: new Date().toISOString()
                }));

                showSuccess('login-success', `Welcome back, ${user.name}! Redirecting...`);
                showNotification(`Demo login successful!`, 'success', `Welcome back, ${user.name}! Role: ${user.role.toUpperCase()}`);

                // Redirect based on role
                setTimeout(() => {
                    if (user.role === 'admin') {
                        window.location.href = 'dashboard.html';
                    } else {
                        window.location.href = 'index.html';
                    }
                }, 2000);

            } catch (error) {
                console.error('Login error:', error);
                showError('login-error', error.message);
                showNotification('Login failed', 'error', error.message);
            } finally {
                hideLoading('#loginForm button[type="submit"]', 'login-spinner', 'login-button-text', 'Sign In');
            }
        }

        // ============================================================================
        // SIGNUP FUNCTIONALITY - PROFESSIONAL IMPLEMENTATION (UPDATED WITH FIRESTORE)
        // ============================================================================

        async function handleSignup(e) {
            e.preventDefault();
           
            const firstName = document.getElementById('signup-firstname').value;
            const lastName = document.getElementById('signup-lastname').value;
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const confirmPassword = document.getElementById('signup-confirm-password').value;
            const termsAgreed = document.getElementById('terms-agreement').checked;
           
            showLoading('#signupForm button[type="submit"]', 'signup-spinner', 'signup-button-text', 'Creating Account...');
            hideError('signup-error');
            hideError('signup-success');

            try {
                // Validate inputs
                if (!firstName || !lastName || !email || !password || !confirmPassword) {
                    throw new Error('Please fill in all fields');
                }

                if (!termsAgreed) {
                    throw new Error('Please agree to the Terms of Service and Privacy Policy');
                }

                if (password !== confirmPassword) {
                    throw new Error('Passwords do not match');
                }

                if (password.length < 6) {
                    throw new Error('Password must be at least 6 characters long');
                }

                // Try Firebase signup first if available
                if (window.firebaseAuth && window.firebaseSignUp && window.saveUserDataToFirestore) {
                    try {
                        console.log("Firebase: Attempting to create user with email:", email);
                        const userCredential = await window.firebaseSignUp(email, password);
                        const user = userCredential.user;
                       
                        console.log("Firebase: User created successfully:", user.email);
                        console.log("Firebase: User UID:", user.uid);
                       
                        // Update user profile with display name
                        if (window.firebaseUpdateUserProfile) {
                            await window.firebaseUpdateUserProfile(user, {
                                displayName: `${firstName} ${lastName}`
                            });
                            console.log("Firebase: User profile updated with display name");
                        }

                        // SAVE USER DATA TO FIRESTORE DATABASE
                        try {
                            console.log("Firebase: Saving user data to Firestore database...");
                            const userData = {
                                firstName: firstName,
                                lastName: lastName,
                                email: email,
                                displayName: `${firstName} ${lastName}`,
                                role: "user",
                                accountStatus: "active",
                                phoneNumber: "",
                                address: "",
                                profileComplete: false
                            };
                           
                            const saved = await window.saveUserDataToFirestore(user.uid, userData);
                            if (saved) {
                                console.log("Firebase: User data successfully saved to Firestore");
                            } else {
                                console.log("Firebase: User created but Firestore save had issues");
                            }
                        } catch (firestoreError) {
                            console.error("Firebase: Error saving to Firestore:", firestoreError);
                            // Continue even if Firestore save fails
                        }

                        // Store user session with enhanced Firebase data
                        sessionStorage.setItem('currentUser', JSON.stringify({
                            email: user.email,
                            uid: user.uid,
                            displayName: `${firstName} ${lastName}`,
                            emailVerified: user.emailVerified,
                            isAnonymous: user.isAnonymous,
                            metadata: user.metadata,
                            providerData: user.providerData,
                            loginTime: new Date().toISOString(),
                            isFirebaseUser: true,
                            firstName: firstName,
                            lastName: lastName
                        }));

                        showSuccess('signup-success', 'Account created successfully! Redirecting to dashboard...');
                        showNotification('Firebase account created!', 'success', 'Welcome to HopeLink! Your account data has been saved to the database.');

                        // Redirect to dashboard
                        setTimeout(() => {
                            window.location.href = 'dashboard.html';
                        }, 2000);
                        return;
                    } catch (firebaseError) {
                        console.log('Firebase signup error:', firebaseError.code, firebaseError.message);
                       
                        // Provide more specific error messages based on Firebase error codes
                        let errorMessage = 'Signup failed';
                        if (firebaseError.code === 'auth/email-already-in-use') {
                            errorMessage = 'An account with this email already exists';
                        } else if (firebaseError.code === 'auth/invalid-email') {
                            errorMessage = 'Invalid email address';
                        } else if (firebaseError.code === 'auth/operation-not-allowed') {
                            errorMessage = 'Email/password accounts are not enabled';
                        } else if (firebaseError.code === 'auth/weak-password') {
                            errorMessage = 'Password is too weak';
                        } else {
                            errorMessage = firebaseError.message;
                        }
                       
                        // Show Firebase error and continue to demo system
                        showNotification('Firebase signup failed', 'error', errorMessage);
                        console.log('Using demo system as fallback');
                    }
                }

                // Check if user already exists in demo system
                const existingUser = demoUsers.find(u => u.email === email);
                if (existingUser) {
                    throw new Error('An account with this email already exists');
                }

                // Simulate API call delay
                await new Promise(resolve => setTimeout(resolve, 2000));

                // Create new user in demo system
                const newUser = {
                    email: email,
                    password: password,
                    name: `${firstName} ${lastName}`,
                    role: 'user',
                    firstName: firstName,
                    lastName: lastName
                };

                demoUsers.push(newUser);

                showSuccess('signup-success', 'Account created successfully! Redirecting to login...');
                showNotification('Demo account created!', 'success', 'Welcome to HopeLink! Your account has been created in demo mode.');

                // Clear form and switch to login
                setTimeout(() => {
                    document.getElementById('signupForm').reset();
                    switchAuthView('login');
                    document.getElementById('login-email').value = email;
                }, 2000);

            } catch (error) {
                console.error('Signup error:', error);
                showError('signup-error', error.message);
                showNotification('Signup failed', 'error', error.message);
            } finally {
                hideLoading('#signupForm button[type="submit"]', 'signup-spinner', 'signup-button-text', 'Create Account');
            }
        }

        // ============================================================================
        // EMAIL SENDING SERVICE
        // ============================================================================

        async function sendOTPDemo(email, otp) {
            // Store OTP in localStorage for demo purposes
            localStorage.setItem(`otp_${email}`, JSON.stringify({
                code: otp,
                expires: Date.now() + 10 * 60 * 1000, // 10 minutes
                attempts: 0
            }));

            // Show OTP in notification for demo
            showNotification(
                `Password reset code sent to ${email}`,
                'success',
                `Your OTP is: ${otp} (Expires in 10 minutes)`
            );

            return true;
        }

        // ============================================================================
        // OTP VERIFICATION
        // ============================================================================

        async function verifyOTP(email, enteredOtp) {
            try {
                // Check demo storage
                const stored = localStorage.getItem(`otp_${email}`);
                if (!stored) {
                    return { valid: false, error: 'No OTP found. Please request a new one.' };
                }

                const otpData = JSON.parse(stored);
               
                // Check expiration
                if (Date.now() > otpData.expires) {
                    localStorage.removeItem(`otp_${email}`);
                    return { valid: false, error: 'OTP has expired. Please request a new one.' };
                }

                // Check attempts
                if (otpData.attempts >= 5) {
                    localStorage.removeItem(`otp_${email}`);
                    return { valid: false, error: 'Too many attempts. Please request a new OTP.' };
                }

                // Verify OTP
                if (otpData.code === enteredOtp) {
                    localStorage.removeItem(`otp_${email}`);
                    return { valid: true };
                } else {
                    // Increment attempts
                    otpData.attempts++;
                    localStorage.setItem(`otp_${email}`, JSON.stringify(otpData));
                   
                    const remaining = 5 - otpData.attempts;
                    return {
                        valid: false,
                        error: `Invalid code. ${remaining} attempts remaining.`
                    };
                }
            } catch (error) {
                return { valid: false, error: 'Verification failed. Please try again.' };
            }
        }

        // ============================================================================
        // OTP UI HANDLERS
        // ============================================================================

        function handleOtpInput(index) {
            const inputs = document.querySelectorAll('.otp-input');
            const currentInput = inputs[index];
            const value = currentInput.value;
           
            // Only allow numbers
            if (value && !/^\d$/.test(value)) {
                currentInput.value = '';
                return;
            }
           
            // Auto-focus next input
            if (value && index < inputs.length - 1) {
                inputs[index + 1].focus();
            }
           
            // Auto-submit when all inputs are filled
            const allFilled = Array.from(inputs).every(input => input.value !== '');
            if (allFilled) {
                document.getElementById('otpVerificationForm').dispatchEvent(new Event('submit'));
            }
        }

        function handleOtpKeyDown(index, event) {
            const inputs = document.querySelectorAll('.otp-input');
           
            if (event.key === 'Backspace') {
                if (inputs[index].value === '' && index > 0) {
                    inputs[index - 1].focus();
                }
            }
           
            if (event.key === 'ArrowLeft' && index > 0) {
                inputs[index - 1].focus();
            }
            if (event.key === 'ArrowRight' && index < inputs.length - 1) {
                inputs[index + 1].focus();
            }
        }

        function getOtpValue() {
            const inputs = document.querySelectorAll('.otp-input');
            return Array.from(inputs).map(input => input.value).join('');
        }

        function resetOtpInputs() {
            const inputs = document.querySelectorAll('.otp-input');
            inputs.forEach(input => {
                input.value = '';
            });
            inputs[0].focus();
        }

        // ============================================================================
        // TIMER FUNCTIONS
        // ============================================================================

        function startOtpTimer() {
            clearInterval(otpTimer);
            let timeLeft = 10 * 60; // 10 minutes
           
            otpTimer = setInterval(() => {
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                document.getElementById('timer').textContent =
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
               
                if (timeLeft <= 0) {
                    clearInterval(otpTimer);
                    showError('otp-error', 'OTP has expired. Please request a new one.');
                }
               
                timeLeft--;
            }, 1000);
        }

        function startResendTimer() {
            clearInterval(resendTimer);
            let timeLeft = 60;
            const resendBtn = document.getElementById('resend-otp-btn');
           
            resendBtn.disabled = true;
            document.getElementById('resend-timer').textContent = timeLeft;
           
            resendTimer = setInterval(() => {
                timeLeft--;
                document.getElementById('resend-timer').textContent = timeLeft;
               
                if (timeLeft <= 0) {
                    clearInterval(resendTimer);
                    resendBtn.disabled = false;
                    document.getElementById('resend-timer').textContent = '0';
                }
            }, 1000);
        }

        // ============================================================================
        // PASSWORD RESET FLOW
        // ============================================================================

        async function handleForgotPassword(e) {
            e.preventDefault();
           
            const email = document.getElementById('forgot-password-email').value;
            currentResetEmail = email;
           
            showLoading('#forgotPasswordForm button[type="submit"]', 'forgot-password-spinner', 'forgot-password-button-text', 'Sending Code...');
            hideError('forgot-password-error');
            hideError('forgot-password-success');

            try {
                // Try Firebase password reset first if available
                if (window.firebaseAuth && window.firebaseSendPasswordReset) {
                    try {
                        console.log("Firebase: Attempting to send password reset email to:", email);
                        await window.firebaseSendPasswordReset(email);
                       
                        console.log("Firebase: Password reset email sent successfully");
                        showSuccess('forgot-password-success', 'Password reset email sent! Check your inbox.');
                        showNotification('Firebase reset email sent!', 'success', 'Check your email for reset instructions from Firebase.');
                       
                        // Switch back to login after showing success
                        setTimeout(() => {
                            switchAuthView('login');
                        }, 3000);
                        return;
                    } catch (firebaseError) {
                        console.log('Firebase password reset error:', firebaseError.code, firebaseError.message);
                       
                        // Provide more specific error messages based on Firebase error codes
                        let errorMessage = 'Password reset failed';
                        if (firebaseError.code === 'auth/user-not-found') {
                            errorMessage = 'No account found with this email address';
                        } else if (firebaseError.code === 'auth/invalid-email') {
                            errorMessage = 'Invalid email address';
                        } else {
                            errorMessage = firebaseError.message;
                        }
                       
                        // Show Firebase error and continue to demo OTP
                        showNotification('Firebase reset failed', 'error', errorMessage);
                        console.log('Using demo OTP as fallback');
                    }
                }

                // Generate OTP for demo system
                otpCode = generateOTP();
               
                // Send OTP via demo service
                await sendOTPDemo(email, otpCode);

                showSuccess('forgot-password-success', 'Verification code sent to your email!');
               
                // Show OTP verification screen
                setTimeout(() => {
                    switchAuthView('otp-verification');
                    document.getElementById('otp-email').textContent = email;
                    resetOtpInputs();
                    startOtpTimer();
                    startResendTimer();
                }, 1000);

            } catch (error) {
                console.error('Password reset error:', error);
                showError('forgot-password-error', 'Failed to send verification code. Please try again.');
                showNotification('Reset failed', 'error', 'Please check your email address.');
            } finally {
                hideLoading('#forgotPasswordForm button[type="submit"]', 'forgot-password-spinner', 'forgot-password-button-text', 'Send Verification Code');
            }
        }

        async function handleOtpVerification(e) {
            e.preventDefault();
           
            const otp = getOtpValue();
           
            if (otp.length !== 6) {
                showError('otp-error', 'Please enter the complete 6-digit code.');
                return;
            }
           
            showLoading('#otpVerificationForm button[type="submit"]', 'otp-spinner', 'otp-button-text', 'Verifying...');
            hideError('otp-error');

            try {
                const verification = await verifyOTP(currentResetEmail, otp);
               
                if (verification.valid) {
                    showNotification('Code verified!', 'success', 'You can now set your new password.');
                   
                    // Move to new password screen
                    setTimeout(() => {
                        switchAuthView('new-password');
                        resetOtpInputs();
                        clearInterval(otpTimer);
                        clearInterval(resendTimer);
                    }, 1000);
                } else {
                    throw new Error(verification.error);
                }
               
            } catch (error) {
                showError('otp-error', error.message);
                showNotification('Verification failed', 'error', error.message);
                resetOtpInputs();
            } finally {
                hideLoading('#otpVerificationForm button[type="submit"]', 'otp-spinner', 'otp-button-text', 'Verify Code');
            }
        }

        async function handleNewPassword(e) {
            e.preventDefault();
           
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-new-password').value;
           
            if (newPassword !== confirmPassword) {
                showError('new-password-error', 'Passwords do not match.');
                return;
            }
           
            if (newPassword.length < 6) {
                showError('new-password-error', 'Password must be at least 6 characters long.');
                return;
            }
           
            showLoading('#newPasswordForm button[type="submit"]', 'new-password-spinner', 'new-password-button-text', 'Resetting Password...');
            hideError('new-password-error');

            try {
                // Simulate API call
                await new Promise(resolve => setTimeout(resolve, 2000));
               
                showNotification('Password reset!', 'success', 'You can now sign in with your new password.');
               
                // Show success screen
                setTimeout(() => {
                    switchAuthView('reset-success');
                }, 1000);
               
            } catch (error) {
                showError('new-password-error', 'Failed to reset password. Please try again.');
                showNotification('Reset failed', 'error', 'Please try again.');
            } finally {
                hideLoading('#newPasswordForm button[type="submit"]', 'new-password-spinner', 'new-password-button-text', 'Reset Password');
            }
        }

        async function handleResendOtp() {
            try {
                otpCode = generateOTP();
                await sendOTPDemo(currentResetEmail, otpCode);
               
                resetOtpInputs();
                startOtpTimer();
                startResendTimer();
               
            } catch (error) {
                showNotification('Failed to resend code', 'error', 'Please try again.');
            }
        }

        // ============================================================================
        // VIEW MANAGEMENT
        // ============================================================================

        function switchAuthView(view) {
            currentView = view;
           
            // Update tabs
            document.getElementById('login-tab').classList.toggle('tab-active', view === 'login');
            document.getElementById('signup-tab').classList.toggle('tab-active', view === 'signup');
            document.getElementById('login-tab').classList.toggle('text-gray-500', view !== 'login');
            document.getElementById('signup-tab').classList.toggle('text-gray-500', view !== 'signup');
           
            // Update containers
            document.getElementById('login-form-container').classList.toggle('hidden', view !== 'login');
            document.getElementById('signup-form-container').classList.toggle('hidden', view !== 'signup');
            document.getElementById('forgot-password-container').classList.toggle('hidden', view !== 'forgot-password');
            document.getElementById('otp-verification-container').classList.toggle('hidden', view !== 'otp-verification');
            document.getElementById('new-password-container').classList.toggle('hidden', view !== 'new-password');
            document.getElementById('reset-success-container').classList.toggle('hidden', view !== 'reset-success');
           
            // Clear errors
            document.querySelectorAll('.error-message, .success-message').forEach(el => {
                el.classList.add('hidden');
            });
        }

        // ============================================================================
        // INITIALIZATION
        // ============================================================================

        function initializeTabs() {
            document.getElementById('login-tab').addEventListener('click', () => switchAuthView('login'));
            document.getElementById('signup-tab').addEventListener('click', () => switchAuthView('signup'));
            document.getElementById('forgot-password-btn').addEventListener('click', () => switchAuthView('forgot-password'));
            document.getElementById('back-to-login').addEventListener('click', () => switchAuthView('login'));
            document.getElementById('back-to-email').addEventListener('click', () => switchAuthView('forgot-password'));
            document.getElementById('back-to-otp').addEventListener('click', () => switchAuthView('otp-verification'));
            document.getElementById('go-to-login').addEventListener('click', () => switchAuthView('login'));
            document.getElementById('resend-otp-btn').addEventListener('click', handleResendOtp);
        }

        function initializeForms() {
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('signupForm').addEventListener('submit', handleSignup);
            document.getElementById('forgotPasswordForm').addEventListener('submit', handleForgotPassword);
            document.getElementById('otpVerificationForm').addEventListener('submit', handleOtpVerification);
            document.getElementById('newPasswordForm').addEventListener('submit', handleNewPassword);
        }

        function checkRememberedUser() {
            const rememberedEmail = localStorage.getItem('rememberedEmail');
            if (rememberedEmail) {
                document.getElementById('login-email').value = rememberedEmail;
                document.getElementById('remember-me').checked = true;
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeTabs();
            initializeForms();
            checkRememberedUser();
           
            console.log('Professional Authentication System Ready');
            console.log('Firestore Database: User data storage enabled');
            console.log('Google OAuth: Enabled');
            console.log('Demo Accounts:');
            console.log('- Admin: admin@hopelink.org / admin123');
            console.log('- User: user@example.com / user123');
           
            // Check Firebase status with enhanced feedback
            setTimeout(() => {
                if (window.firebaseAuth && window.firebaseDb) {
                    console.log('✅ Firebase Authentication: Connected to project:', window.firebaseAuth.app.name);
                    console.log('✅ Firestore Database: Connected and ready for user data storage');
                    console.log('✅ Firebase Functions Available: signIn, signUp, updateProfile, saveUserDataToFirestore, signInWithGoogle');
                    updateFirebaseStatus(true);
                   
                    // Check if there's a current user
                    if (window.firebaseAuth.currentUser) {
                        console.log('✅ Firebase: Current user detected:', window.firebaseAuth.currentUser.email);
                    }
                } else {
                    console.log('⚠️ Firebase Authentication: Not connected (using demo mode)');
                    updateFirebaseStatus(false);
                }
            }, 500);
        });

        // Make functions available globally
        window.handleOtpInput = handleOtpInput;
        window.handleOtpKeyDown = handleOtpKeyDown;
        window.handleGoogleLogin = handleGoogleLogin;
    </script>
</body>
</html>

